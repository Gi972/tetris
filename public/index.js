+function(){function e(e){return e.toString().split("").reverse().join("").match(/.{1,3}/g).join(" ").split("").reverse().join("")}function t(e,t,n){var r=n-e.length-t.length;return e+l.repeat(r>0?r:0)+t}function n(e){return document.getElementById(e)}function r(e,t){function n(){e.innerHTML="|/-\\".charAt(o)+l.repeat(t),o=++o>3?0:o}var r=e.innerHTML,o=0;t=(t||0)>0?t-1:0;var a=setInterval(n,50);return n(),function(){clearInterval(a),e.innerHTML=r}}function o(e,t,n){function r(e){(e.which||e.keyCode)===n&&t()}return e.addEventListener("keydown",r),function(){e.removeEventListener("keydown",r)}}function a(e,t){return o(e,t,13)}function s(e,t){return o(e,t,27)}function i(o,i,c){function u(){n("userboard-send").removeEventListener("click",l),n("userboard-close").removeEventListener("click",d),n("userboard").style.display="none",y(),m()}function d(){u(),c()}function l(){var e=n("name-input").value.toLocaleUpperCase();if(e&&!(e.length>10)){n("userboard-send").removeEventListener("click",l),y(),o.name=e;var t=new XMLHttpRequest;t.open("POST","https://tetris-tiurin.rhcloud.com/api/scores",!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){t.readyState==XMLHttpRequest.DONE&&200==t.status&&(a(),u(),i())},t.send(Object.keys(o).map(function(e){return e+"="+o[e]}).join("&"));var a=r(n("userboard-send"));try{localStorage.setItem("tetrisName",e)}catch(e){}}}n("userboard").style.display="block",n("your-score").innerHTML=t("YOUR SCORE:",e(o.score),32);try{var v=(new Date).getTime(),f=JSON.parse(localStorage.getItem("tetrisScore"))||[];f.push({t:v,s:o.score}),localStorage.setItem("tetrisScore",JSON.stringify(f));var p=f.sort(function(e,t){return t.s-e.s})[0].s;n("your-best-score").innerHTML=t("YOUR BEST SCORE:",e(p),32)}catch(e){}try{n("name-input").value=localStorage.getItem("tetrisName")}catch(e){}n("name-input").focus(),n("userboard-send").addEventListener("click",l),n("userboard-close").addEventListener("click",d);var y=a(n("name-input"),l),m=s(document,d)}function c(o){function a(){i.style.display="none",u.removeEventListener("click",a),d(),o()}var i=n("leaderboard");if("block"!==i.style.display){i.style.display="block";var c=r(n("score-leaders"),32),u=n("leaderboard-close");u.addEventListener("click",a),u.focus();var d=s(document,a),l=new XMLHttpRequest;l.open("GET","https://tetris-tiurin.rhcloud.com/api/scores",!0),l.onload=function(r){var o=JSON.parse(r.target.response);"ok"===o.status&&(c(),n("score-leaders").innerHTML=o.scores.map(function(n){return t(n.name,e(n.score),32)}).join("<br>"))},l.send()}}function u(e){e.target.dataset&&e.target.dataset.key&&(TETRIS.pressKey(parseInt(e.target.dataset.key)),e.target.blur())}function d(){function e(){clearInterval(n),n=0}function t(t){if(!(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey||(keyCode=t.which>0?t.which:t.keyCode,n&&keyCode===r))){r=keyCode;var o=function(){TETRIS.pressKey(keyCode)};o(),e();var a={37:100,39:100,40:50};n=setInterval(o,a[keyCode]||200)}}var n,r;return TETRIS.upause(),setTimeout(function(){addEventListener("keyup",e),addEventListener("keydown",t),addEventListener("click",u)}),function(){clearInterval(n),removeEventListener("keyup",e),removeEventListener("keydown",t),removeEventListener("click",u),TETRIS.pause()}}var l="&nbsp;",v=d();TETRIS.on({finish:function(e,t,n){v(),i({score:e,level:t,rowsHit:n},function(){c(function(){TETRIS.start(),v=d()})},function(){TETRIS.start(),v=d()})},nextFrame:function(e){e=e.replace(/[ <>]|\n\r/g,function(e){return{" ":"&nbsp;","<":"&lsaquo;",">":"&rsaquo;","\n\r":"<br>"}[e]}),n("game").innerHTML=e}}),n("leaderboard-link").addEventListener("click",function(){v(),c(function(){v=d()})})}();